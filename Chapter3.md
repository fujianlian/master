# 密钥和地址

比特币的所有权是通过**数字密钥、比特币地址和数字签名**来确定的。数字密钥实际上并不存储在网络中，而是由用户生成之后，存储在一个叫做*钱包*的文件或简单的数据库中。用户钱包中的数字密钥完全独立于比特币协议，可由用户的钱包软件生成并管理，而无需参照区块链或访问互联网。密钥实现了比特币的许多有趣特性，包括去中心化信任和控制、所有权认证和基于密码学证明的安全模型。

大多数比特币交易都需要在区块链中存储一个有效的数字签名。该数字签名只能由密钥产生，因此拥有密钥副本就等于拥有了该帐户中比特币的控制权。用于支出资金的数字签名也称为*见证（witness）*，这是加密技术中的术语。 比特币交易中的见证数据证明了资金的真正所有权。

密钥是成对出现的，由私钥和公钥所组成。公钥就像银行的帐号，而私钥就像PIN码或支票的签名。比特币的用户很少会直接看到数字密钥。一般情况下，它们存储在钱包文件内，由比特币钱包软件进行管理。

在比特币交易的支付环节，收款人的公钥由数字指纹表示，称为*比特币地址*，就像支票上收款人名称 （即“付给谁的账户”）。一般情况下，比特币地址由公钥生成并与之对应。然而，并非所有比特币地址都代表公钥； 也可以代表其他支付对象，譬如脚本，我们将在本章后面提及。这样一来，比特币地址就可以抽象成资金接收者，使得交易更灵活，就像纸质支票：可以支付到个人账户、公司账户，支付账单和现金。比特币地址是密钥的唯一形式，人们只需要把比特币地址告诉别人就可以。

## 私钥和公钥

一个比特币钱包中包含一系列的密钥对，每个密钥对包括一个私钥和一个公钥。私钥（*k*）是一个数字，通常是随机选出的。基于私钥，我们就可以使用椭圆曲线乘法这个单向加密函数产生一个公钥（*K*）。基于公钥（*K*），我们就可以使用一个单向加密哈希函数生成比特币地址（*A*）。在本节中，我们将从生成私钥开始，讲述如何使用椭圆曲线运算将私钥生成公钥，并最终由公钥生成比特币地址。私钥、公钥和比特币地址之间的关系如下图所示。

![图4-1私钥、公钥和比特币地址之间的关系](https://static.sitestack.cn/projects/MasterBitcoin2CN/mbc2_0401.png)



**为什么使用非对称加密（公钥/私钥）？**

为什么在比特币中使用非对称加密技术？ 它不是用于对交易进行“加密”（保密）的。 相反，非对称加密技术的最有用特性是生成数字签名。 可以将私钥用作交易的数字指纹来产生数字签名。 该签名只能由知晓私钥的人生成。 但是，任何访问公钥和交易指纹的人都可以验证签名。 这种非对称密码学的适用性使得任何人都可以验证每笔交易的每个签名，并且确保只有私钥的所有者可以生成有效的签名。

### 私钥

私钥就是一个随机选出的数字而已。拥有和控制了私钥，就相当于控制了该私钥对应的比特币地址中的所有资金。通过证明比特币交易中资金的所有权，私钥可以生成花费该笔资金的签名。私钥任何情况下都必须保密，因为一旦被泄露给第三方，相当于该私钥保护之下的比特币也拱手相让了。私钥还必须进行备份，以防意外丢失，因为私钥一旦丢失就无法恢复，其所保护的比特币也将永远丢失。

**提示** 比特币私钥只是一个数字。你可以用硬币、铅笔和纸来随机生成你的私钥：掷硬币256次，用纸和笔记录正反面并转换为0和1，随机得到的256位二进制数字可作为比特币钱包的私钥。该私钥可进一步生成公钥。

以下是一个随机生成的私钥（k），以十六进制格式表示（256位的二进制数，转变为十六进制是64位，每个十六进制数占4位）：

1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD

**提示** 比特币私钥空间的大小是2256，这是一个非常大的数字。用十进制表示的话，大约是1077，而可见宇宙被估计只含有1080个原子

### 公钥

通过椭圆曲线乘法可以从私钥计算得到公钥，这是不可逆转的过程：*K = k* G *。其中* k *是私钥，*G *是被称为*生成点*的常数点，而* K *是所得公钥。其反向运算，被称为“寻找离散对数”——已知公钥K来求出私钥*k*——是非常困难的，就像去尝试所有可能的*k*值，即暴力搜索。

## 比特币地址

比特币地址是一个由数字和字母组成的字符串，可以展示给任何给你转账比特币的人。由公钥（一个同样由数字和字母组成的字符串）生成的比特币地址以数字“1”开头。下面是一个比特币地址的例子：

1J7mdg5rbQyUHENYdx39WVWK7fsLpEoXZy

比特币地址可由公钥经过单向加密哈希算法得到。哈希算法是一种单向函数，接收任意长度的输入产生指纹或哈希。加密哈希函数在比特币中被广泛使用 ：比特币地址、脚本地址以及在挖矿中的工作量证明算法。由公钥生成比特币地址时使用的算法是Secure Hash Algorithm (SHA)和the RACE Integ rity Primitives Evaluation Message Digest (RIPEMD)，具体来说是SHA256和RIPEMD160。

以公钥 *K* 为输入，计算其SHA256哈希值，并以此结果计算RIPEMD160 哈希值，得到一个长度为160位（20字节）的数字：

A = RIPEMD160(SHA256(K))

公式中，***K***是公钥，***A***是生成的比特币地址。

通常用户见到的比特币地址是经过“Base58Check”编码的，这种编码使用了58个字符（Base58数字系统）和校验码，提高了可读性、避免歧义并有效防止了在地址转录和输入中产生的错误。Base58Check编码也被用于比特币的其它地方，例如比特币地址、私钥、加密的密钥和脚本哈希中，用来提高可读性和录入的正确性。下一节中我们会详细解释Base58Check的编码和解码机制，以及它产生的结果。

下图描述了如何从公钥生成比特币地址。

![图4-5从公钥生成比特币地址](https://static.sitestack.cn/projects/MasterBitcoin2CN/mbc2_0405.png)

###  Base58和Base58Check编码

为了更简洁方便地表示长串的数字，使用更少的符号，许多计算机系统在表示大于十进制时，会使用数字和字母混合组成。例如，传统的十进制计数系统使用0-9十个数字，而十六进制系统使用了16个，增加了 A-F 六个字母来表示0-9额外的符号。一个同样的数字，它的十六进制表示就会比等值得十进制表示更短。

Base64使用了**26个小写字母、26个大写字母、10个数字以及两个符号（例 如“+”和“/”）**，用于在像电子邮件这样的文本媒介中传输二进制数据。Base64通常用于邮件中添加二进制附件。

Base58 是一种基于文本的二进制编码格式，用在比特币和其它的加密货币中。这种编码格式提供了紧凑表示，易读性，错误检测预防这几方面彼此之间的平衡。Base58是Base64编码格式的子集，同样使用大小写字母和10个数字，但舍弃了一些容易读错和在特定字体中外观容易混淆的字符。具体地，Base58不含Base64中的0（数字0）、O（大写字母o）、l（小写字母 L）、I（大写字母i），以及“+”和“/”两个字符。简而言之，Base58就是由**不包括（0，O，l，I）的大小写字母和数字组成**。

比特币的Base58字母表：**123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz**

为了增加防止打印和转录错误的安全性，比特币常用的是Base58Check，它是一种内置错误校验代码的Base58编码格式。检验和是额外4个字节，被添加到正在编码的数据末端。校验和是从编码的数据的哈希值中得到的，所以可以用来检测并避免转录和输入中产生的错误。使用Base58check编码时，解码软件会计算数据的校验和并和编码中自带的校验和进行对比。二者不匹配则表明有错误产生，这个Base58Check的数据就是无效的。这就防止输错的比特币地址被钱包软件认为是有效的地址，造成资金的丢失。

为了将数据（数字）转换成Base58Check格式，首先我们要对数据添加一个称作“版本字节”的前缀，这个前缀用来识别编码的数据的类型。例如，比特币地址的前缀是0（十六进制是0x00），而编码私钥的前缀是128（十六进制是0x80）。 表4-1会列出一些常见版本的前缀。

接下来，我们计算“双哈希”校验和，意味着要对之前的结果（前缀和数据）运行两次SHA256哈希算法：

```
checksum = SHA256(SHA256(prefix+data))
```

在产生的长度为32个字节的哈希值（两次哈希运算）中，我们只取前4个字节。这4个字节就作为检验错误的代码或者校验和。将校验码添加到最后。

结果由三部分组成：前缀、数据和校验和。这个结果采用之前描述的Base58字母表编码。下图描述了Base58Check编码的过程。

![图4-6Base58Check编码的过程](https://static.sitestack.cn/projects/MasterBitcoin2CN/mbc2_0406.png)

### 公钥的格式

钥是在椭圆曲线上的一个点，由一对坐标（x，y）组成。公钥通常表示为前缀04紧接着两个256位的数字。其中一个256位数字是公钥的x坐标，另一个256位数字是y坐标。**前缀04是是非压缩格式公钥， 压缩格式公钥是以02或者03开头**

#### 压缩格式公钥

如果我们知道了公钥的x坐标，就可以通过解方程y2 mod p = (x3 + 7) mod p得到y坐标。这可以让我们只存储公钥的x坐标，略去y坐标，从而将公钥的大小和存储空间减少了256位。这样每笔交易需要的字节数减少了近一半，随着时间推移，就能保存更多的交易数据。

压缩格式公钥是以02或03作为前缀。为什么会有两个前缀：因为椭圆曲线加密的公式的左边是y2 ，也就是说y的解是来自于一个平方根，可能是正值也可能是负值。更形象地说，y坐标可能在x坐标轴的上面或者下面。y坐标可能是偶数或者奇数，分别对应前面所讲的y值的正/负符号。因此，为了区分y坐标的两种可能值，在生成压缩格式公钥时，如果**y是偶数，则使用02作为前缀；如果y是奇数，则使用03作为前缀**

